if (self.CavalryLogger) { CavalryLogger.start_js(["Sli2u"]); }

__d("WaterfallMessageLifetimeTypedLogger",["Banzai","GeneratedLoggerUtils","nullthrows"],(function(a,b,c,d,e,f){"use strict";__p&&__p();a=function(){__p&&__p();function a(){this.$1={}}var c=a.prototype;c.log=function(){b("GeneratedLoggerUtils").log("logger:WaterfallMessageLifetimeLoggerConfig",this.$1,b("Banzai").BASIC)};c.logVital=function(){b("GeneratedLoggerUtils").log("logger:WaterfallMessageLifetimeLoggerConfig",this.$1,b("Banzai").VITAL)};c.logImmediately=function(){b("GeneratedLoggerUtils").log("logger:WaterfallMessageLifetimeLoggerConfig",this.$1,{signal:!0})};c.clear=function(){this.$1={};return this};c.getData=function(){return babelHelpers["extends"]({},this.$1)};c.updateData=function(a){this.$1=babelHelpers["extends"]({},this.$1,a);return this};c.setAttemptID=function(a){this.$1.attempt_id=a;return this};c.setDestService=function(a){this.$1.dest_service=a;return this};c.setDeviceID=function(a){this.$1.device_id=a;return this};c.setEventType=function(a){this.$1.event_type=a;return this};c.setIsBatch=function(a){this.$1.is_batch=a;return this};c.setIsGroup=function(a){this.$1.is_group=a;return this};c.setMessageID=function(a){this.$1.message_id=a;return this};c.setOfflineThreadingID=function(a){this.$1.offline_threading_id=a;return this};c.setPageID=function(a){this.$1.page_id=a;return this};c.setPushNotifID=function(a){this.$1.push_notif_id=a;return this};c.setReceiptID=function(a){this.$1.receipt_id=a;return this};c.setSenderID=function(a){this.$1.sender_id=a;return this};c.setServiceName=function(a){this.$1.service_name=a;return this};c.setSrcService=function(a){this.$1.src_service=a;return this};c.setThreadID=function(a){this.$1.thread_id=a;return this};c.setTime=function(a){this.$1.time=a;return this};c.setTimeStamp=function(a){this.$1.time_stamp=a;return this};c.setTopic=function(a){this.$1.topic=a;return this};c.setWeight=function(a){this.$1.weight=a;return this};c.updateExtraData=function(a){a=b("nullthrows")(b("GeneratedLoggerUtils").serializeMap(a));b("GeneratedLoggerUtils").checkExtraDataFieldNames(a,g);this.$1=babelHelpers["extends"]({},this.$1,a);return this};c.addToExtraData=function(a,b){var c={};c[a]=b;return this.updateExtraData(c)};return a}();var g={attempt_id:!0,dest_service:!0,device_id:!0,event_type:!0,is_batch:!0,is_group:!0,message_id:!0,offline_threading_id:!0,page_id:!0,push_notif_id:!0,receipt_id:!0,sender_id:!0,service_name:!0,src_service:!0,thread_id:!0,time:!0,time_stamp:!0,topic:!0,weight:!0};e.exports=a}),null);
__d("MercuryRealTimeEnvironmentDropDown",["Arbiter","Bootloader","FBLogger","MessengerMQTTGating"],(function(a,b,c,d,e,f){"use strict";__p&&__p();var g={token:null,init:function(){g.token=b("Arbiter").subscribe("mqtt-websocket-connection-died",g.handleConnectionDied)},handleConnectionDied:function(){if(!g.token||!b("MessengerMQTTGating").isEnabled())return;g.token&&(b("Arbiter").unsubscribe(g.token),g.token=null);g.dropDownToChannel()},dropDownToChannel:function(){b("MessengerMQTTGating").turnOff(),b("Bootloader").loadModules(["ChannelManager"],function(a){a.startChannelManager(),b("Arbiter").inform("messenger-mqtt-drop-down-to-channel")},"MercuryRealTimeEnvironmentDropDown"),b("FBLogger")("messenger_web_mqtt").warn("drop down to channel")}};e.exports=g}),null);
__d("MercurySyncResnapshot",["Promise","Bootloader","MercurySingletonProvider"],(function(a,b,c,d,e,f){"use strict";__p&&__p();a=function(){__p&&__p();function a(a){this.$2=a}a.getForFBID=function(a){return g.getForFBID(a)};a.get=function(){return g.get()};var c=a.prototype;c.resnapshot=function(){var a=this;this.$1||(this.$1=new(b("Promise"))(function(c,d){b("Bootloader").loadModules(["MercurySyncDeltaHandler"],function(b){b.getForFBID(a.$2).emergencyDFF(function(b){c(b),a.$1=null},function(){d(),a.$1=null})},"MercurySyncResnapshot")}));return this.$1};return a}();var g=new(b("MercurySingletonProvider"))(a);e.exports=a}),null);
__d("IrisSubscribeChecker",["MqttLogger","clearTimeout","setTimeoutAcrossTransitions"],(function(a,b,c,d,e,f){"use strict";__p&&__p();a=function(){__p&&__p();function a(){this.$1=b("MqttLogger").getInstance(),this.$2=null,this.$3=!1,this.$4=!1,this.$5=!1}var c=a.prototype;c.onConnectAttempt=function(){};c.onConnectFailure=function(){};c.onConnected=function(){var a=this;this.$6();this.$3=!1;this.$4=!1;this.$5=!1;this.$2=b("setTimeoutAcrossTransitions")(function(){a.$7()},8e3)};c.onConnectSuccess=function(){};c.onConnectionLost=function(){this.$6()};c.onSubscribe=function(a){a==="/t_ms"&&(this.$3=!0)};c.onUnsubscribe=function(a){};c.onPublish=function(a){(a==="/messenger_sync_get_diffs"||a==="/messenger_sync_create_queue")&&(this.$4=!0,this.$3&&(this.$5=!0,this.$6()))};c.onMessage=function(a){};c.$6=function(){this.$2!==null&&(b("clearTimeout")(this.$2),this.$2=null)};c.$7=function(){var a=window.location.hostname;a=a.replace(/\./g,"-");this.$3===!1&&(this.$1.bumpCounter(a+".no_iris_topic_subscribe"),this.$1.debugTrace("irisSubscribeChecker","iris topic not subscribed"));this.$4===!1&&(this.$1.bumpCounter(a+".no_iris_session"),this.$1.debugTrace("irisSubscribeChecker","iris session not subscribed"));this.$3===!0&&this.$4===!0&&this.$5===!1&&(this.$1.bumpCounter(a+".session_before_topic_subscribe"),this.$1.debugTrace("irisSubscribeChecker","iris session subscribed before topic subscribe"))};return a}();e.exports=a}),null);
__d("MqttWaterfallLogger",["WaterfallMessageLifetimeTypedLogger","gkx"],(function(a,b,c,d,e,f){"use strict";a={logNewMessageToWaterfall:function(a){var c=a.senderID,d=a.receiptID,e=a.messageID,f=a.offlineThreadingID,g=a.threadID,h=a.irisSeqId;a=a.isGroup;if(!b("gkx")("832242"))return;new(b("WaterfallMessageLifetimeTypedLogger"))().setEventType("message_receive_ws").setSrcService("mqtt").setDestService("webclient").setSenderID(c).setReceiptID(d).setMessageID(e).setOfflineThreadingID(f).setThreadID(g).setIsGroup(a?1:0).addToExtraData("sync_seq_id",h).log()}};e.exports=a}),null);
__d("exponentialBackoff",["Random","clearTimeout","setTimeoutAcrossTransitions"],(function(a,b,c,d,e,f){__p&&__p();function a(a,c){__p&&__p();c===void 0&&(c=null);var d=null,e=0;function f(){__p&&__p();for(var f=arguments.length,g=new Array(f),h=0;h<f;h++)g[h]=arguments[h];var i=function(){a.apply(c,g)};if(e===0)i();else if(d===null){var j=Math.pow(2,Math.min(e,6))*(1e3+b("Random").random()*200);d=b("setTimeoutAcrossTransitions")(function(){i(),d=null},j)}e++}f.reset=function(){e=0,d!=null&&(b("clearTimeout")(d),d=null)};f.isPending=function(){return d!=null};return f}e.exports=a}),null);
__d("MessageEventStream",["Int64","IrisSubscribeChecker","MercurySingletonProvider","MqttLogger","MqttWaterfallLogger","exponentialBackoff","setTimeoutAcrossTransitions"],(function(a,b,c,d,e,f){"use strict";__p&&__p();a=function(){__p&&__p();a.getForFBID=function(a){return g.getForFBID(a)};function a(a){var c=this;this.connectToIris=function(a){a===void 0&&(a=null),a!==null&&(c.$4=b("Int64").fromString(a)),c.$9=!0,c.$16()};this.$2="Disconnected";this.$1=a;this.$3=[];this.$6=b("MqttLogger").getInstance();this.$12=new(b("exponentialBackoff"))(this.connectToIris,this);this.$11=new(b("IrisSubscribeChecker"))()}var c=a.prototype;c.init=function(a,c,d,e){__p&&__p();var f=this;if(!c&&!e)return this;this.$10=a;this.$10.addHook(this.$11);this.$9=!0;this.$4=c?b("Int64").fromString(c):null;this.$7=d;this.$8=e;this.$5=null;this.$10.subscribe("/t_ms",function(a){return f.$13(a)});this.$10.subscribe("/thread_typing",function(a){f.$14(a)});this.$10.subscribe("/orca_typing_notifications",function(a){f.$14(a)});this.$10.subscribe("/notify_disconnect",function(a){return f.$15(a)});this.connectToIris();return this};c.$16=function(){var a=this;this.$5?this.$17():(this.$18(),b("setTimeoutAcrossTransitions")(function(){a.$5==null?a.$6.bumpCounter("syncTokenUnassigned_5s"):a.$6.bumpCounter("syncTokenAssigned_5s")},5e3))};c.$19=function(a){var b=null;try{b=JSON.parse(a)}catch(a){this.$6.logError(a,"Unable to process data")}return b};c.$14=function(a){var b=this.$19(a);if(b==null){this.$6.logWarn("_processTypingData","Unable to process typing data");return}this.$3.forEach(function(a){typeof a.onTypingReceived==="function"&&a.onTypingReceived(b)})};c.addDeltaStreamListener=function(a){this.$3.push(a)};c.$15=function(a){this.$6.logWarn("_handleNotifyDisconnect","Disconnecting reason: "+a),this.$6.bumpCounter("notify_disconnect_"+a),a==="IRIS_CURSOR_LIMIT"&&this.$20(a)};c.$20=function(a){this.$6.bumpCounter(a+"_request"),this.$5=null,this.$9=!1,this.$3.forEach(function(b){return b.onStreamDisconnect(a)})};c.$13=function(a){__p&&__p();a=this.$19(a);if(a==null){this.$6.logWarn("_processDeltas","Unable to process delta");return}var b={syncToken:a.syncToken,entityId:a.queueEntityId,errorCode:a.errorCode,firstSeqId:a.firstDeltaSeqId,lastSeqId:a.lastIssuedSeqId};this.$6.debugTrace("Sync data received",JSON.stringify(b));b=this.$1;if(a.syncToken){this.$21(a);return}else if(a.queueEntityId!=b){this.$6.bumpCounter("delta_for_other_fbid");return}else a.errorCode?this.$22(a.errorCode):this.$23(a)};c.$22=function(a){this.$6.bumpCounter("iris_queue_error."+a),this.$6.logWarn("_handleIrisError","Recevied an error code from sync protocol "+a),a==="ERROR_QUEUE_TEMPORARY_NOT_AVAILABLE"?this.$12():this.$20(a)};c.$21=function(a){var c=this;this.$5=a.syncToken;this.$4=b("Int64").fromString(a.firstDeltaSeqId.toString());this.$6.debugTrace("Sync token received",JSON.stringify({token:this.$5}));this.$10.subscribeChannelEvents({onMQTTStateChanged:function(a){c.$9&&c.$2!=="Connected"&&a==="Connected"&&(c.$12.reset(),c.$16()),c.$2=a}});this.$2="Connected"};c.$23=function(a){var c=a.deltas,d=this.$4;if(c&&d){var e=b("Int64").fromString(a.firstDeltaSeqId.toString());a=b("Int64").fromString(a.lastIssuedSeqId.toString());e.equals(d.add(b("Int64").ONE))?this.$24(e,a,c):e.compare(d)<0?(this.$6.bumpCounter("delta_batch_in_middle"),a.compare(d)>0&&this.$24(d.add(b("Int64").ONE),a,c)):(this.$6.bumpCounter("missing_deltas_get_diffs"),this.$17())}else this.$6.bumpCounter("process_deltas_invalid_state")};c.$24=function(a,c,d){__p&&__p();a=a;for(var e=0;e<d.length;e++){var f=d[e],g=f["class"]||"Missing";try{g=="NewMessage"&&b("MqttWaterfallLogger").logNewMessageToWaterfall({senderID:f.messageMetadata.actorFbId,receiptID:this.$1,messageID:f.messageMetadata.messageId,offlineThreadingID:f.messageMetadata.offlineThreadingId,threadID:f.messageMetadata.threadKey.threadFbId!=null?f.messageMetadata.threadKey.threadFbId:"",irisSeqId:f.irisSeqId?f.irisSeqId:a.toString(),isGroup:f.messageMetadata.threadKey.threadFbId!=null})}catch(a){this.$6.logError(a,"Unable to log to waterfall")}var h={seqId:a.toString(),type:g,status:""},i=1;if(g!="Missing")try{i=this.$25(f,g,a,h)}catch(a){h.status="err:"+a.message}else h.status="no type",this.$6.bumpCounter("missing_delta_type");this.$6.debugTrace("onDeltaReceived",JSON.stringify(h));a=a.add(b("Int64").fromInt(i))}this.$4=c};c.$25=function(a,c,d,e){__p&&__p();var f=1,g="";c==="NoOp"&&(f=a.numNoOps||f,g+="n:"+f);a.irisSeqId||(a.irisSeqId=d.toString(),g+="missing seq id");var h=b("Int64").fromString(a.irisSeqId.toString())||d;h.equals(d)?g+=" seqId match":(g+=" seqId mismatch",this.$6.bumpCounter("seq_id_running_id_mismatch"));var i={type:c,payload:a};this.$3.forEach(function(a){return a.onDeltaReceived(i)});e.status=g;return f};c.$18=function(){var a={sync_api_version:10,max_deltas_able_to_process:1e3,delta_batch_size:500,encoding:"JSON",entity_fbid:this.$1,initial_titan_sequence_id:this.$4&&this.$4.toString(),device_params:this.$7,queue_position:this.$8};this.$6.debugTrace("Sending create queue request",JSON.stringify({seqId:this.$4&&this.$4.toString()}));this.$10.publish("/messenger_sync_create_queue",JSON.stringify(a))};c.$17=function(){__p&&__p();if(!this.$4){this.$6.bumpCounter("get_diffs_no_seq_id");return}if(!this.$5){this.$6.bumpCounter("get_diffs_no_sync_token");return}var a={sync_token:this.$5,sync_api_version:10,max_deltas_able_to_process:1e3,delta_batch_size:500,encoding:"JSON",entity_fbid:this.$1,last_seq_id:this.$4.toString()};this.$6.debugTrace("Sending get diff request",JSON.stringify({token:this.$5,seqId:this.$4&&this.$4.toString()}));this.$10.publish("/messenger_sync_get_diffs",JSON.stringify(a))};return a}();var g=new(b("MercurySingletonProvider"))(a);e.exports=a}),null);
__d("MessengerMQTTPayloadPreprocessor",[],(function(a,b,c,d,e,f){"use strict";a={process:function(a,b,c){var d=parseInt(c.irisSeqId.toString(),10);return{seqID:d,obj:{queue:a,iseq:d,delta:c,seqID:d,type:b}}}};e.exports=a}),null);
__d("MessengerMQTTPresence",["FBMqttChannel","PresenceStatus"],(function(a,b,c,d,e,f){"use strict";__p&&__p();var g="/orca_presence",h=!1;a={subscribe:function(){if(h)return;h=!0;b("FBMqttChannel").subscribe(g,function(a){a=JSON.parse(a);a&&a.list&&b("PresenceStatus").setMultiFromMQTT(a.list)})},unsubscribe:function(){h=!1,b("FBMqttChannel").unsubscribe(g)}};e.exports=a}),null);
__d("MessengerMQTTPresenceActivity",["Event","MercuryConfig","MessengerMQTTPresence","UserActivity"],(function(a,b,c,d,e,f){__p&&__p();var g=b("MercuryConfig").idle_limit||18e5;a=b("MercuryConfig").idle_poll_interval||3e5;var h=Date.now(),i=!0;function j(){h=Date.now(),b("MessengerMQTTPresence").subscribe()}c={init:function(){b("Event").listen(window,"focus",function(){i=!0,j()}),b("Event").listen(window,"blur",function(){i=!1}),b("UserActivity").subscribe(function(){j()})}};window.setInterval(function(){!i&&Date.now()-h>g&&b("MessengerMQTTPresence").unsubscribe()},a);e.exports=c}),null);
__d("MessengerMQTTTypingDataPreProcessor",[],(function(a,b,c,d,e,f){"use strict";a={process:function(a,b){var c=b.thread;a=c==null?{from:b.sender_fbid,st:b.state,to:a,type:"typ"}:{from:b.sender_fbid,st:b.state,thread:c,thread_fbid:c,type:"ttyp"};return{obj:a}}};e.exports=a}),null);
__d("MessengerMQTTConnection",["Arbiter","CurrentUser","FBMqttChannel","MercuryRealTimeEnvironmentDropDown","MercurySingletonProvider","MercurySyncResnapshot","MessageEventStream","MessengerMQTTConnectionEvents","MessengerMQTTPayloadPreprocessor","MessengerMQTTPresence","MessengerMQTTTypingDataPreProcessor","MqttLogger","gkx","promiseDone"],(function(a,b,c,d,e,f){"use strict";__p&&__p();var g=b("MessengerMQTTConnectionEvents").DELTA_EVENT,h=b("MessengerMQTTConnectionEvents").STREAM_CONNECT,i=b("MessengerMQTTConnectionEvents").STREAM_DISCONNECT,j=b("MessengerMQTTConnectionEvents").STREAM_CONNECTING,k=b("MessengerMQTTConnectionEvents").STATE_CONNECTED,l=b("MessengerMQTTConnectionEvents").STATE_CONNECTING,m=b("MessengerMQTTConnectionEvents").STATE_DISCONNECTED,n=b("MessengerMQTTConnectionEvents").TYP;a=function(){__p&&__p();a.getForFBID=function(a){return o.getForFBID(a)};a.get=function(){return o.get()};function a(a){this.$1=a,this.connectionState=m}a.setUp=function(c){__p&&__p();var e=c.fbid,f=c.irisSeqID;c.appID;c.endpoint;b("MercuryRealTimeEnvironmentDropDown").init();if(!e||!f)return;c=b("MqttLogger").getInstance();if(!b("CurrentUser").isLoggedInNow()){c.debugTrace("run","User not logged in");c.bumpCounter("user_not_loggged_in");return}var g=a.getForFBID(e);a.addDeltaStream({fbid:e,irisSeqID:f});var n=function(){b("Arbiter").inform(h)};b("FBMqttChannel").getConnectionState()===k&&(g.connectionState=k,n());b("FBMqttChannel").subscribeChannelEvents({onMQTTStateChanged:function(a){switch(a){case k:n();break;case l:b("Arbiter").inform(j);break;case m:b("Arbiter").inform(i);break}g.connectionState=a},onJSError:function(a){g.$2()}});(b("gkx")("845715")||b("gkx")("845716"))&&b("MessengerMQTTPresence").subscribe();b("gkx")("845716")&&d(["MessengerMQTTPresenceActivity"],function(a){a.init()})};a.addDeltaStream=function(c){var d=c.fbid;c=c.irisSeqID;var e=a.getForFBID(d),f=null;b("gkx")("687751")&&(f={accept_pending_deltas:!0});b("MessageEventStream").getForFBID(d).init(b("FBMqttChannel"),c,f).addDeltaStreamListener(e)};var c=a.prototype;c.onDeltaReceived=function(a){var c=a.type;a=a.payload;c=b("MessengerMQTTPayloadPreprocessor").process(this.$1,c,a);b("Arbiter").inform(g,c)};c.onStreamDisconnect=function(a){__p&&__p();var c=this;if(a==="IRIS_CURSOR_LIMIT"){this.$2();return}if(a==="ERROR_QUEUE_LOST"||a==="QUEUE_NOT_FOUND"||a==="ERROR_QUEUE_EXCEEDS_MAX_DELTAS"||a==="ERROR_QUEUE_UNDERFLOW"||a==="ERROR_QUEUE_OVERFLOW"){b("promiseDone")(b("MercurySyncResnapshot").getForFBID(this.$1).resnapshot(),function(a){b("MessageEventStream").getForFBID(c.$1).connectToIris(a.toString())},function(){c.$2()});return}b("Arbiter").inform(i,a)};c.onTypingReceived=function(a){a=b("MessengerMQTTTypingDataPreProcessor").process(this.$1,a);b("Arbiter").inform(n,a)};c.$2=function(){b("Arbiter").inform("mqtt-websocket-connection-died"),b("MqttLogger").getInstance().logWarn("connection_died","Dropping down to ChatProxy")};return a}();var o=new(b("MercurySingletonProvider"))(a);e.exports=a}),null);